<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Сканер штрих-кодів</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div id="reader" style="width: 100%; max-width: 600px;"></div>
    <p id="result"></p>
    <button onclick="stopScanner()" style="display: none;" id="stopButton">Зупинити сканер</button>

    <script>
        const html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", { fps: 10, qrbox: 250 });
        let scannerRunning = false;

        function onScanSuccess(decodedText, decodedResult) {
            if (!scannerRunning) return;
            scannerRunning = false;
            document.getElementById("result").innerHTML = `Знайдено штрих-код: ${decodedText}`;
            document.getElementById("stopButton").style.display = "none";
            html5QrcodeScanner.clear();

            // Відправка результату в Telegram через WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.sendData(decodedText);
                window.Telegram.WebApp.close();
            } else {
                alert("Не вдалося відправити дані в Telegram. Використовуйте Telegram WebApp.");
            }
        }

        function onScanError(errorMessage) {
            // Обробка помилок сканування
            console.error("Scan error:", errorMessage);
            document.getElementById("result").innerHTML = "Помилка сканування: " + errorMessage;
        }

        function startScanner() {
            if (!scannerRunning) {
                document.getElementById("stopButton").style.display = "inline";
                html5QrcodeScanner.render(onScanSuccess, onScanError)
                    .catch(err => {
                        console.error("Failed to start scanner:", err);
                        document.getElementById("result").innerHTML = "Не вдалося запустити сканер: " + err;
                        alert("Будь ласка, надайте доступ до камери для сканування.");
                    });
                scannerRunning = true;
            }
        }

        function stopScanner() {
            if (scannerRunning) {
                html5QrcodeScanner.clear();
                scannerRunning = false;
                document.getElementById("stopButton").style.display = "none";
                document.getElementById("result").innerHTML = "Сканер зупинено.";
            }
        }

        // Ініціалізація Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
        }

        // Автоматичний запуск сканера
        window.onload = function() {
            startScanner();
        };
    </script>
</body>
</html>
