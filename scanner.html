<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Сканування штрих-коду</title>
  <script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    #scanner-container {
      width: 100%;
      height: 60vh;
      background: black;
      position: relative;
    }
    #status {
      color: white;
      position: absolute;
      top: 10px;
      left: 10px;
    }
    #barcode {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 15px;
      display: inline-block;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <h1>Сканування штрих-коду</h1>
  <div id="scanner-container">
    <div id="status">Сканування...</div>
  </div>
  <p>Товар з кодом: <span id="barcode">Очікування сканування</span></p>

  <script>
    let currentDeviceId = null;

    async function startScanner(deviceId = null) {
      if (Quagga.initialized) {
        Quagga.stop();
      }

      // Автоматичний вибір задньої камери
      if (!deviceId && !currentDeviceId) {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === "videoinput");
        console.log("Доступні камери:", videoDevices.map(cam => ({ id: cam.deviceId, label: cam.label })));
        if (videoDevices.length === 0) {
          alert("Камери не знайдено");
          return;
        }
        let rearCamera = videoDevices.find(cam => cam.label.toLowerCase().includes("rear") || cam.label.toLowerCase().includes("back"));
        if (!rearCamera) {
          // Спроба знайти камеру з facingMode "environment"
          for (let cam of videoDevices) {
            try {
              const stream = await navigator.mediaDevices.getUserMedia({
                video: { deviceId: { exact: cam.deviceId }, facingMode: "environment" }
              });
              stream.getTracks().forEach(track => track.stop());
              rearCamera = cam;
              console.log("Знайдено задню камеру:", cam.deviceId);
              break;
            } catch (err) {
              console.log("Камера не підтримує environment:", cam.deviceId);
            }
          }
        }
        currentDeviceId = rearCamera ? rearCamera.deviceId : videoDevices[0].deviceId;
        console.log("Обрана камера:", currentDeviceId);
      } else if (deviceId) {
        currentDeviceId = deviceId;
      }

      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#scanner-container'),
          constraints: {
            deviceId: currentDeviceId ? { exact: currentDeviceId } : undefined,
            facingMode: "environment" // Примусово задня камера
          }
        },
        decoder: {
          readers: ["ean_reader", "ean_8_reader", "code_128_reader", "upc_reader"]
        },
        locate: true
      }, function(err) {
        if (err) {
          console.error("Quagga init error:", err);
          alert("Помилка ініціалізації сканера. Перевір дозвіл на камеру або перезавантаж сторінку.");
          return;
        }
        Quagga.initialized = true;
        Quagga.start();
      });

      Quagga.onDetected(function(result) {
        const barcode = result.codeResult.code;
        const decoder = result.codeResult.decoder;
        console.log("Виявлено код:", barcode, "Декодер:", decoder, "Довжина:", barcode.length);

        // Спрощена фільтрація: приймаємо всі коди від валідних декодерів
        const validDecoders = ["ean_reader", "ean_8_reader", "code_128_reader", "upc_reader"];
        if (barcode && validDecoders.includes(decoder)) {
          document.getElementById("barcode").textContent = barcode;
          Quagga.stop();

          // Перенаправлення з закриттям сторінки
          setTimeout(() => {
            window.location.href = `https://t.me/NSGChat_bot?start=${encodeURIComponent(barcode)}`;
            window.close();
          }, 500);
        } else {
          console.warn("Недійсний штрих-код:", barcode, "Декодер:", decoder);
          document.getElementById('status').textContent = 'Сканування... (Недійсний код)';
        }
      });
    }

    window.addEventListener('load', async () => {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Цей браузер не підтримує доступ до камери.");
        return;
      }

      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
        startScanner();
      } catch (err) {
        console.error("Доступ до камери заборонено:", err);
        alert("❌ Доступ до камери заборонено або не підтримується цим пристроєм.");
      }
    });
  </script>
</body>
</html>
