<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Сканер штрих-коду (Debug)</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: monospace;
      background: #1e1e1e;
      color: #00ff99;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      margin-top: 20px;
    }
    #status, #log {
      width: 100%;
      max-width: 400px;
      padding: 10px;
      margin-top: 10px;
      background: #2e2e2e;
      border-radius: 5px;
      font-size: 0.95em;
    }
    #log {
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .error { color: #ff5555; }
    .success { color: #00ff99; }
    .warn { color: #ffaa00; }
  </style>
</head>
<body>
  <div id="reader"></div>
  <div id="status" class="warn">⏳ Ініціалізація сканера...</div>
  <div id="log"></div>

  <script>
    const statusElem = document.getElementById("status");
    const logElem = document.getElementById("log");

    function log(message, type = 'log') {
      const entry = document.createElement('div');
      entry.className = type;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logElem.appendChild(entry);
      logElem.scrollTop = logElem.scrollHeight;
      console.log(message);
    }

    function updateStatus(message, type = 'log') {
      statusElem.textContent = message;
      statusElem.className = type;
      log(`STATUS: ${message}`, type);
    }

    const sendCodeToBot = (code) => {
      updateStatus(`✅ Код зчитано: ${code}`, 'success');
      try {
        if (window.Telegram && Telegram.WebApp) {
          log("Telegram WebApp виявлено. Надсилаю дані...");
          Telegram.WebApp.sendData(code);
          Telegram.WebApp.close();
        } else {
          updateStatus("❌ Telegram WebApp API недоступний", 'error');
          log("Telegram.WebApp API не знайдено", 'error');
        }
      } catch (err) {
        updateStatus("❌ Помилка надсилання коду", 'error');
        log("SEND ERROR: " + err.message, 'error');
      }
    };

    const html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devices => {
      if (!devices.length) {
        updateStatus("❌ Камери не знайдено", 'error');
        log("CAMERA ERROR: Жодної камери не знайдено", 'error');
        return;
      }

      const cameraId = devices[0].id;
      log(`Камера обрана: ${devices[0].label || "без назви"}`);

      html5QrCode.start(
        cameraId,
        {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0
        },
        (decodedText, decodedResult) => {
          log(`✅ Успішне зчитування: ${decodedText}`, 'success');
          html5QrCode.stop().then(() => {
            log("Сканування зупинено", 'log');
            sendCodeToBot(decodedText);
          }).catch(err => {
            updateStatus("❌ Не вдалося зупинити сканування", 'error');
            log("STOP ERROR: " + err.message, 'error');
          });
        },
        (errorMessage) => {
          log("Спроба зчитування: " + errorMessage, 'warn');
        }
      );
      updateStatus("✅ Камера активна — наведи на штрих-код", 'success');
    }).catch(err => {
      updateStatus("❌ Не вдалося отримати доступ до камери", 'error');
      log("GETCAMERA ERROR: " + err.message, 'error');
    });
  </script>
</body>
</html>
