<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#f4f4f4">
  <title>Потужний сканер штрих-кодів</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #f4f4f4, #e0e0e0);
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      transition: background 0.5s;
    }
    #scanner-container {
      width: 90%;
      max-width: 640px;
      height: 60vh;
      background: black;
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 5px rgba(0, 0, 255, 0.5); }
      50% { box-shadow: 0 0 15px rgba(0, 0, 255, 0.8); }
      100% { box-shadow: 0 0 5px rgba(0, 0, 255, 0.5); }
    }
    #scanner-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #scanner-overlay {
      position: absolute;
      top: 10%;
      left: 10%;
      width: 80%;
      height: 80%;
      border: 3px dashed red;
      opacity: 0.7;
      pointer-events: none;
      transition: border 0.3s;
    }
    #status {
      color: white;
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 1.2rem;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    #barcode {
      font-size: 1.8rem;
      font-weight: bold;
      margin: 20px;
      padding: 12px 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      display: inline-block;
      animation: bounceIn 1s;
    }
    #controls {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
    #restart-btn, #switch-cam-btn {
      padding: 10px 20px;
      font-size: 1rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #restart-btn:hover, #switch-cam-btn:hover {
      background-color: #0056b3;
    }
    #error {
      color: #ff4444;
      margin-top: 10px;
      font-size: 1.1rem;
      padding: 8px;
      background: rgba(255, 0, 0, 0.1);
      border-radius: 5px;
      display: none;
    }
    #info {
      position: fixed;
      bottom: 10px;
      font-size: 0.9rem;
      color: #666;
      background: rgba(255, 255, 255, 0.8);
      padding: 5px 10px;
      border-radius: 5px;
    }
    @media (max-width: 480px) {
      #scanner-container { height: 50vh; }
      #barcode { font-size: 1.5rem; }
    }
  </style>
</head>
<body>
  <h1>Потужний сканер штрих-кодів</h1>
  <div id="scanner-container">
    <div id="status">Сканування...</div>
    <div id="scanner-overlay"></div>
  </div>
  <p>Товар з кодом: <span id="barcode">Очікування сканування</span></p>
  <div id="controls">
    <button id="restart-btn" style="display: none;">Сканувати ще</button>
    <button id="switch-cam-btn">Переключити камеру</button>
  </div>
  <div id="error"></div>
  <div id="info">Використовуйте задню камеру. Тримайте штрих-код у рамці.</div>

  <script>
    let isScanning = false;
    let currentDeviceId = null;
    let availableCameras = [];
    let isRearCamera = true;

    async function startScanner(deviceId = null) {
      if (isScanning) {
        Quagga.stop();
        isScanning = false;
      }

      document.getElementById('restart-btn').style.display = 'none';
      document.getElementById('status').textContent = 'Сканування...';
      document.getElementById('barcode').textContent = 'Очікування сканування';
      document.getElementById('error').style.display = 'none';
      document.getElementById('scanner-overlay').style.border = '3px dashed red';

      try {
        if (!deviceId && availableCameras.length === 0) {
          const devices = await navigator.mediaDevices.enumerateDevices();
          availableCameras = devices.filter(device => device.kind === "videoinput");
          if (availableCameras.length === 0) throw new Error("Камери не знайдено");
          // Примусово обираємо задню камеру за замовчуванням
          currentDeviceId = availableCameras.find(cam => cam.label.toLowerCase().includes("rear") || cam.label.toLowerCase().includes("back"))?.deviceId;
          if (!currentDeviceId) {
            // Якщо задньої камери немає, шукаємо першу з facingMode "environment"
            const rearCandidate = availableCameras.find(cam => {
              const constraints = { video: { deviceId: { exact: cam.deviceId } } };
              return navigator.mediaDevices.getUserMedia(constraints).then(stream => {
                stream.getTracks().forEach(track => track.stop());
                return true;
              }).catch(() => false);
            })?.deviceId;
            currentDeviceId = rearCandidate || availableCameras[0].deviceId;
            console.warn("Задню камеру не знайдено за назвою, використано:", currentDeviceId);
          }
        } else if (deviceId) {
          currentDeviceId = deviceId;
        }

        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            deviceId: currentDeviceId ? { exact: currentDeviceId } : undefined,
            width: { min: 640, ideal: 1280, max: 1920 },
            height: { min: 480, ideal: 720, max: 1080 },
            facingMode: "environment" // Примусово задня камера
          }
        });

        Quagga.init({
          inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#scanner-container'),
            constraints: {
              deviceId: currentDeviceId ? { exact: currentDeviceId } : undefined,
              width: { min: 640, ideal: 1280, max: 1920 },
              height: { min: 480, ideal: 720, max: 1080 },
              facingMode: "environment"
            }
          },
          decoder: {
            readers: ["ean_reader", "ean_8_reader", "code_128_reader", "upc_reader", "upc_e_reader"],
            multiple: false
          },
          locator: {
            patchSize: "medium",
            halfSample: true
          },
          numOfWorkers: (navigator.hardwareConcurrency || 4) > 4 ? 4 : navigator.hardwareConcurrency || 1,
          locate: true
        }, function(err) {
          if (err) {
            console.error("Quagga init error:", err);
            document.getElementById('error').textContent = 'Помилка: ' + (err.message || 'Не вдалося ініціалізувати сканер');
            document.getElementById('error').style.display = 'block';
            isScanning = false;
            return;
          }
          console.log("Quagga ініціалізовано з пристроєм:", currentDeviceId);
          Quagga.start();
          isScanning = true;
        });

        Quagga.onDetected(function(result) {
          const barcode = result.codeResult.code;
          console.log("Виявлено код:", barcode, "Тип декодера:", result.codeResult.decoder);

          // Виправлена фільтрація: приймаємо лише валідні штрих-коди
          const validLengths = {
            "ean_reader": [13, 8],
            "ean_8_reader": [8],
            "code_128_reader": [6, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20],
            "upc_reader": [12],
            "upc_e_reader": [6, 7, 8]
          };
          const decoder = result.codeResult.decoder;
          const lengthValid = validLengths[decoder] ? validLengths[decoder].includes(barcode.length) : false;
          const isNumeric = /^\d+$/.test(barcode);

          if (barcode && isNumeric && lengthValid) {
            Quagga.stop();
            isScanning = false;
            document.getElementById('status').textContent = 'Сканування завершено';
            document.getElementById('barcode').textContent = barcode;
            document.getElementById('scanner-overlay').style.border = '3px solid green';
            document.getElementById('restart-btn').style.display = 'inline-block';

            setTimeout(() => {
              window.location.href = `https://t.me/NSGChat_bot?start=${encodeURIComponent(barcode)}`;
              window.close();
            }, 500);
          } else {
            console.warn("Недійсний штрих-код:", barcode, "Довжина:", barcode.length, "Декодер:", decoder);
            document.getElementById('status').textContent = 'Сканування... (Недійсний код)';
            document.getElementById('scanner-overlay').style.border = '3px dashed red';
          }
        });

        Quagga.onProcessed(function(result) {
          if (result && result.box) {
            document.getElementById('scanner-overlay').style.border = '3px solid yellow';
          }
        });
      } catch (err) {
        console.error("Помилка доступу до камери:", err);
        document.getElementById('error').textContent = 'Помилка: ' + (err.message || 'Не вдалося отримати доступ до камери');
        document.getElementById('error').style.display = 'block';
        isScanning = false;
      }
    }

    function speak(text) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'uk-UA';
        window.speechSynthesis.speak(utterance);
      }
    }

    function initAROverlay() {
      if ('xr' in navigator) {
        console.log("WebXR доступний, ініціалізація AR...");
      }
    }

    window.addEventListener('load', async () => {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        document.getElementById('error').textContent = 'Цей браузер не підтримує доступ до камери';
        document.getElementById('error').style.display = 'block';
        return;
      }

      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
        startScanner();
        initAROverlay();
      } catch (err) {
        console.error("Доступ до камери заборонено:", err);
        document.getElementById('error').textContent = '❌ Доступ до камери заборонено або не підтримується';
        document.getElementById('error').style.display = 'block';
      }
    });

    document.getElementById('restart-btn').addEventListener('click', () => {
      startScanner(currentDeviceId);
    });

    document.getElementById('switch-cam-btn').addEventListener('click', () => {
      if (availableCameras.length > 1) {
        const currentIndex = availableCameras.findIndex(cam => cam.deviceId === currentDeviceId);
        const nextIndex = (currentIndex + 1) % availableCameras.length;
        currentDeviceId = availableCameras[nextIndex].deviceId;
        startScanner(currentDeviceId);
      } else {
        document.getElementById('error').textContent = 'Тільки одна камера доступна';
        document.getElementById('error').style.display = 'block';
      }
    });

    window.onbeforeunload = function() {
      if (isScanning) {
        Quagga.stop();
      }
    };
  </script>
</body>
</html>
