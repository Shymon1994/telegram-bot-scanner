<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сканування штрих-коду</title>
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        #scanner { width: 100%; max-width: 400px; height: 300px; border: 1px solid #ccc; margin: 20px auto; }
        #result { margin: 20px; font-size: 18px; }
        button { padding: 10px 20px; font-size: 16px; margin: 5px; }
        #torchToggle { display: none; } /* Приховуємо кнопку ліхтарика за замовчуванням */
    </style>
</head>
<body>
    <h1>Сканування штрих-коду</h1>
    <video id="scanner" autoplay playsinline></video>
    <p id="result">Ініціалізація…</p>
    <div>
        <button onclick="startScanner()">Почати сканування</button>
        <button onclick="stopScanner()">Сканувати ще раз</button>
        <button onclick="openTelegram()">Відкрити у Telegram</button>
        <button id="torchToggle" onclick="toggleTorch()">Ліхтарик</button>
    </div>
    <p>Формати: EAN-13 / EAN-8 / UPC-A. Контрольна сума + 3 підтвердження. Автовибір задньої камери.</p>

    <script>
        let codeReader = new ZXing.BrowserMultiFormatReader();
        let selectedDeviceId;
        let isScanning = false;
        let torchEnabled = false;

        // Ініціалізація сканера
        async function startScanner() {
            if (isScanning) return;
            isScanning = true;
            document.getElementById('result').innerText = 'Очікування сканування…';

            try {
                const videoInputDevices = await codeReader.getVideoInputDevices();
                if (videoInputDevices.length === 0) {
                    document.getElementById('result').innerText = 'Камера не знайдена.';
                    return;
                }

                // Автовибір задньої камери
                selectedDeviceId = videoInputDevices[videoInputDevices.length - 1].deviceId; // Зазвичай задня камера
                codeReader.decodeFromVideoDevice(selectedDeviceId, 'scanner', (result, err) => {
                    if (result) {
                        document.getElementById('result').innerText = `Товар з кодом: ${result.text}`;
                        stopScanner(); // Зупиняємо сканування після успіху
                    }
                    if (err && !(err instanceof ZXing.NotFoundException)) {
                        console.error(err);
                        document.getElementById('result').innerText = 'Помилка сканування.';
                    }
                });

                // Перевірка наявності ліхтарика
                const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: selectedDeviceId } });
                const track = stream.getVideoTracks()[0];
                if (track.getCapabilities().torch) {
                    document.getElementById('torchToggle').style.display = 'inline-block';
                }
                stream.getTracks().forEach(track => track.stop());
            } catch (err) {
                document.getElementById('result').innerText = 'Помилка доступу до камери: ' + err.message;
                console.error(err);
            }
        }

        // Зупинка сканера
        function stopScanner() {
            codeReader.reset();
            isScanning = false;
            document.getElementById('result').innerText = 'Сканування зупинено. Натисніть "Почати сканування".';
        }

        // Переключення ліхтарика
        async function toggleTorch() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: selectedDeviceId } });
                const track = stream.getVideoTracks()[0];
                if (track.getCapabilities().torch) {
                    await track.applyConstraints({
                        advanced: [{ torch: !torchEnabled }]
                    });
                    torchEnabled = !torchEnabled;
                    document.getElementById('torchToggle').textContent = torchEnabled ? 'Вимкнути ліхтарик' : 'Ліхтарик';
                }
                stream.getTracks().forEach(track => track.stop());
            } catch (err) {
                console.error('Помилка з ліхтариком:', err);
            }
        }

        // Відкриття Telegram
        function openTelegram() {
            const code = document.getElementById('result').innerText.replace('Товар з кодом: ', '').trim();
            if (code) {
                window.location.href = `https://t.me/NSGChat_bot?start=${encodeURIComponent(code)}`; // Замініть на ваш username бота
            } else {
                window.location.href = 'https://t.me/NSGChat_bot'; // Замініть на ваш username бота
            }
        }

        // Запуск при завантаженні
        window.onload = () => {
            document.getElementById('result').innerText = 'Натисніть "Почати сканування" для старту.';
        };
    </script>
</body>
</html>
